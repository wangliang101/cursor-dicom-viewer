# DICOM文件排序功能

## 功能概述

为了解决上传整个DICOM文件夹后图像顺序不连续的问题，我们实现了基于DICOM标签的智能排序功能。

## 问题描述

在上传整个文件夹时，浏览器返回的文件列表顺序往往是无序的，导致：

- 播放时上一张和下一张图像不连续
- 图像序列的医学逻辑顺序被打乱
- 影响诊断和观察的连贯性

## 解决方案

实现了多级DICOM标签排序算法，按以下优先级排序：

### 排序优先级

1. **Series Number (0020,0011)** - 序列编号
2. **Instance Number (0020,0013)** - 实例编号（最常用）
3. **Slice Location (0020,1041)** - 切片位置
4. **Image Position Patient (0020,0032)** - 患者坐标系中的图像位置（Z坐标）
5. **Acquisition Number (0020,0012)** - 采集编号
6. **文件名** - 自然排序（兜底方案）
7. **原始索引** - 最后的兜底方案

## 使用方法

### 1. 上传界面的排序选项

在上传模态框中选择排序方式：

- **DICOM标签排序**（推荐）：根据DICOM标签进行智能排序
- **文件名排序**：简单的文件名自然排序

### 2. 自动排序

系统会在上传时自动执行以下步骤：

1. 解析每个DICOM文件的关键标签
2. 根据多级排序规则进行排序
3. 按排序后的顺序生成图像ID列表
4. 确保播放时的连续性

## 技术实现

### 核心文件

- `src/utils/dicomSorter.js` - 排序算法实现
- `src/store/slices/dicomSlice.js` - 集成排序功能
- `src/components/UploadModal/index.jsx` - 排序选项UI

### 关键函数

```javascript
// 对DICOM文件进行排序
export async function sortDicomFiles(fileList)

// 按文件名排序（兜底方案）
export function sortByFileName(fileList)
```

## 验证方法

### 测试步骤

1. 准备一组DICOM文件（建议使用CT或MRI序列）
2. 上传整个文件夹
3. 选择"DICOM标签排序"
4. 观察序列面板中的图像顺序
5. 使用播放功能验证连续性

### 预期结果

- 图像按医学逻辑顺序排列
- 播放时前后帧连续
- 控制台输出排序信息用于调试

### 调试信息

在浏览器控制台中可以看到：

```
开始对DICOM文件进行排序...
原始文件顺序: [...]
排序后文件顺序: [...]
排序信息: [{ fileName, instanceNumber, sliceLocation, ... }]
```

## 兼容性

### 支持的DICOM标签

- 所有常用的位置和序列标签
- 如果某些标签缺失，会自动降级到其他可用标签
- 完全兼容无DICOM标签的文件（降级到文件名排序）

### 错误处理

- 解析失败时不会中断整个排序流程
- 无效文件会保持在原始位置
- 提供详细的错误日志用于诊断

## 性能考虑

- 异步并行解析DICOM文件
- 仅解析必要的标签，不加载完整的文件内容
- 大文件集合时显示加载状态

## 未来改进

- [ ] 支持更多DICOM标签组合
- [ ] 用户自定义排序规则
- [ ] 排序结果的可视化预览
- [ ] 时间序列的特殊处理
- [ ] 多序列混合时的智能分组
